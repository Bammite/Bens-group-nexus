<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Suivi de livraison en direct - Bens Group</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/general.css">
    <link rel="stylesheet" href="/css/modals.css">
    <link rel="stylesheet" href="/css/livraison.css">
    <link rel="stylesheet" href="/css/chatbot.css">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

</head>
<body>
    <div class="chatbot_icon" id="chatbot_icon">
            <img src="/assets/svg/chat_icon.svg" alt="">
        </div>
        <div id="chatbot-container" class="chatbot-container">
            <div class="chatbot-header">
                <a href="./chatbot_mobile.html" target="_blank">
                    <img src="./assets/svg/extende.svg" alt="Agrandir">
                </a>
                <h3>Discuter avec l'assistant</h3>
                <span id="close-chatbot" class="close-chatbot">&times;</span>
            </div>
            <div class="chatbot-messages" id="chatbot-messages">
                <div class="message bot">Bonjour ! Je suis l'assistant de Bens Groupe. Comment puis-je vous aider ?</div>
            </div>
            <div class="chatbot-input-area">
                <input type="text" id="user-input" placeholder="Posez votre question...">
                <button id="send-btn">Envoyer</button>
            </div>
        </div>
 <div id="modal-images" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2>Images du chargement</h2>
        <div class="gallery">
            <span>Aucune image disponible</span>
        </div>
    </div>
</div>
<div id="modal-justificatif" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2>Justificatif de livraison</h2>
        <div class="pdf-viewer">
            <span>Aucune fichier disponible</span>
        </div>
    </div>
</div>

<div id="modal-reception" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2>Confirmer la réception</h2>
        <form id="form-reception">
            <p>Veuillez confirmer que vous avez bien reçu votre colis.</p>
            <div class="form-group">
                <label for="reception-image">Ajouter une photo (optionnel)</label>
                <input type="file" id="reception-image" name="reception-image" accept="image/*">
            </div>
            <div class="form-group-checkbox">
                <input type="checkbox" id="reception-confirm" name="reception-confirm" required>
                <label for="reception-confirm">Je confirme avoir reçu mon colis en bon état.</label>
            </div>
            <button type="submit" class="btn-submit">Envoyer la confirmation</button>
        </form>
    </div>
</div>

<div id="modal-probleme" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2>Signaler un problème</h2>
        <form id="form-probleme">
            <div class="form-group">
                <label for="probleme-description">Décrivez le problème rencontré :</label>
                <textarea id="probleme-description" name="probleme-description" rows="5" required></textarea>
            </div>
            <button type="submit" class="btn-submit">Envoyer le signalement</button>
        </form>
    </div>
</div>

<div id="modal-auth-required" class="modal-overlay ">
    <div class="modal-content modal-auth-required">
        <button class="close-modal">&times;</button>
        <h2>Authentification requise</h2>
        <p>Vous devez être connecté pour accéder à cette fonctionnalité.</p>
        <a href="/authentification" class="btn-submit">S'authentifier</a>
    </div>
</div>

<div id="panel-expanded" class="info-panel">
        <div class="panel-header">
            <div class="info">
                <p class="nom">Livraison container (Ref: A7ehg-ejke)</p>
                <p class="statut"></p>
            </div>
            <button id="collapse-btn" class="icon-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </button>
        </div>

        <div class="commande">
            <button id="btn-images" class="btncmd">
                <span>Images du chargement</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
            </button>
            <button id="btn-justificatif" class="btncmd">
                <span>Consulter le justificatif</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            </button>
            <button id="btn-reception" class="btncmd">
                <span>Confirmer la reception</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </button>
            <button id="btn-probleme" class="btncmd problem">
                <span>Signaler un problème</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
            </button>
        </div>
    </div>

    <div id="panel-collapsed" class="info-panel-collapsed hidden">
        <div class="info">
            <p class="nom">Livraison container (Ref: A7ehg-ejke)</p>
            <p class="statut">en cours</p>
        </div>
        <button id="expand-btn" class="icon-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        </button>
    </div>

    <div id="map"></div>



  <script src="/accesoire/ElementPrimaire/loader.js"></script>
  <script src="/js/chatbot.js"></script>
  <script> 
    LoadingAnimation.start();
  </script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <script src="/js/livraison-ui-controller.js"></script>
    <script src="/js/modals.js"></script>

    
    <script type="module">
        // Variables globales
        let map;
        let truckMarker;
        let userMarker;
        let idLigneTransport;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            LoadingAnimation.start();
            
            // 1. Récupérer la clé Mapbox de manière sécurisée depuis le backend
            const tokenResponse = await fetch('/api/config/mapbox-token');
            const tokenData = await tokenResponse.json();
            if (!tokenData.success) {
                return showError(tokenData.error || 'Impossible de charger la configuration de la carte.');
            }
            mapboxgl.accessToken = tokenData.token;
 
            // Récupération de l'ID depuis l'URL
            // L'URL est maintenant /livraison/ID, on récupère la dernière partie.
            const pathParts = window.location.pathname.split('/');
            idLigneTransport = pathParts[pathParts.length - 1];
            
            if (!idLigneTransport) {
                showError("ID de livraison manquant");
                return;
            }

            try {
                // 2. Charger les informations de base de la livraison
                const deliveryData = await getDeliveryInfo();

                // 3. Mettre à jour l'interface (panneau) avec les informations
                updateUI(deliveryData);

                // 4. Vérifier si la livraison est "En cours"
                if (deliveryData.Statut_Trajet?.toLowerCase() !== 'en cours') {
                    // Si non, afficher un message à la place de la carte et arrêter
                    displayStatusMessage(`Le suivi en direct n'est pas disponible. Statut de la livraison : <strong>${deliveryData.Statut_Trajet}</strong>`);
                    LoadingAnimation.stop();
                    return;
                }

                // 5. Si oui, initialiser la carte et charger le reste des données
                await initMap();
                await loadTrackingData();
                setupRealTimeUpdates();
                
            } catch (error) {
                console.error("Erreur initialisation:", error);
                showError("Erreur de chargement des données de livraison.");
                // Assurons-nous que l'animation s'arrête en cas d'erreur précoce
                LoadingAnimation.stop();
            }
        });

        function displayStatusMessage(message) {
            const mapDiv = document.getElementById('map');
            // On s'assure que le panneau reste visible en ne cachant pas tout le body
            mapDiv.innerHTML = `<div class="status-message-overlay">${message}</div>`;
        }

        async function initMap() {
            // Position par défaut (Dakar)
            const defaultCenter = [-17.46768, 14.7167];
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: defaultCenter,
                zoom: 12
            });
            
            // Attendre que la carte soit prête
            return new Promise(resolve => {
                map.on('load', resolve);
            });
        }

        async function loadTrackingData() {
            try {
                const [routeData, userPosition] = await Promise.all([
                    getRouteEndpoints(),
                    getUserPosition()
                ]);
                
                const { startPoint, endPoint } = routeData;
                await updateMarkersAndRoute(startPoint, endPoint, userPosition);
            } finally {
                // Arrête l'animation que le chargement réussisse ou échoue
                LoadingAnimation.stop();
            }
        }

        async function getDeliveryInfo() {
            const response = await fetch(`/api/data/delivery-info/${idLigneTransport}`);
            if (!response.ok) {
                throw new Error("Livraison introuvable");
            }
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            console.log("Données de livraison récupérées:", result.data);
            return result.data;
        }

        async function getRouteEndpoints() {
            const response = await fetch(`/api/data/delivery-route/${idLigneTransport}`);
            if (!response.ok) {
                throw new Error("Impossible de récupérer l'itinéraire.");
            }
            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            console.log("Endpoints récupérés:", result.data);
            return result.data; // This will be { startPoint, endPoint }
        }

        async function getUserPosition() {
            return new Promise(resolve => {
                if (!navigator.geolocation) return resolve(null);
                navigator.geolocation.getCurrentPosition(
                    pos => resolve([pos.coords.longitude, pos.coords.latitude]),
                    () => resolve(null)
                );
            });
        }

        function updateUI(deliveryData) {
            const deliveryName = deliveryData.Ref_Ligne_Transport || `Livraison (Ref: ${idLigneTransport})`;
            document.querySelectorAll('.nom').forEach(el => {
                el.textContent = deliveryName;
            });

            const status = deliveryData.Statut_Trajet || 'en cours';
            document.querySelectorAll('.statut').forEach(el => {
                el.textContent = status;
                el.className = `statut ${status.toLowerCase().replace(/ /g, '-')}`;
            });
        }

        async function updateMarkersAndRoute(startPoint, endPoint, userPos) {
            const bounds = new mapboxgl.LngLatBounds();

            let startCoords = null;
            if (startPoint && startPoint.position) {
                // Correction: Utiliser _longitude et _latitude pour les GeoPoints de Firestore
                startCoords = [startPoint.position._longitude, startPoint.position._latitude];
                // Ajouter un marqueur simple pour le point de départ
                new mapboxgl.Marker({ color: '#32CD32' }) // Vert
                    .setLngLat(startCoords)
                    .setPopup(new mapboxgl.Popup().setHTML("<h4>Point de départ</h4>"))
                    .addTo(map);
                bounds.extend(startCoords);
            }

            let endCoords = null;
            if (endPoint && endPoint.position) {
                // Correction: Utiliser _longitude et _latitude pour les GeoPoints de Firestore
                endCoords = [endPoint.position._longitude, endPoint.position._latitude];
                // Ajouter le marqueur du camion pour le point le plus récent
                if (!truckMarker) {
                    const el = document.createElement('div');
                    el.className = 'marker truck-marker';
                    truckMarker = new mapboxgl.Marker(el)
                        .setLngLat(endCoords)
                        .setPopup(new mapboxgl.Popup().setHTML("<h4>Votre livreur</h4>"))
                        .addTo(map);
                } else {
                    truckMarker.setLngLat(endCoords);
                }
                bounds.extend(endCoords);
            }

            // Marqueur de l'utilisateur
            if (userPos) {
                if (!userMarker) {
                    const el = document.createElement('div');
                    el.className = 'marker user-marker';
                    userMarker = new mapboxgl.Marker(el)
                        .setLngLat(userPos) 
                        .setPopup(new mapboxgl.Popup().setHTML("<h4>Votre position</h4>"))
                        .addTo(map);
                } else {
                    userMarker.setLngLat(userPos);
                }
                bounds.extend(userPos);
            }

            // Tracer l'itinéraire si nous avons les deux points
            if (startCoords && endCoords) {
                await drawRoute(startCoords, endCoords);
            }

            // Ajuster la vue
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds, {
                    padding: 100,
                    maxZoom: 15,
                    duration: 1000
                });
            }
        }

        async function drawRoute(start, end) {
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;

            try {
                const response = await fetch(url);
                const json = await response.json();
                if (!json.routes || json.routes.length === 0) {
                    console.warn("Aucun itinéraire trouvé par Mapbox.");
                    return;
                }
                const data = json.routes[0];
                const route = data.geometry.coordinates;
                const geojson = {
                    type: 'Feature',
                    properties: {},
                    geometry: { type: 'LineString', coordinates: route }
                };

                if (map.getSource('route')) {
                    map.getSource('route').setData(geojson);
                } else {
                    map.addSource('route', { type: 'geojson', data: geojson });
                    map.addLayer({
                        id: 'route', type: 'line', source: 'route',
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#3887be', 'line-width': 5, 'line-opacity': 0.75 }
                    });
                }
            } catch (error) {
                console.error("Erreur lors du traçage de l'itinéraire:", error);
            }
        }

        function setupRealTimeUpdates() {
            console.log("Mises à jour en temps réel configurées pour", idLigneTransport);
        }

        function showError(message) {
            console.error(message);
            alert(message);
            // Redirection après 3 secondes
            setTimeout(() => {
                window.location.href = '/';
            }, 10000);
        }
    </script>
</body>
</html>